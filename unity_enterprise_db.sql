-- Unity Enterprise Database Script (v1.10)
-- Compatible with SQL Server Enterprise / Standard / Express
-- Generated by Unity Assistant

USE master;
GO

IF EXISTS (SELECT * FROM sys.databases WHERE name = 'UnityDB')
BEGIN
    ALTER DATABASE UnityDB SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
    DROP DATABASE UnityDB;
END
GO

CREATE DATABASE UnityDB;
GO

USE UnityDB;
GO

-- =============================================
-- 1. Tables
-- =============================================

-- Departments
CREATE TABLE Departments (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    Description NVARCHAR(MAX),
    HeadOfDepartment NVARCHAR(100),
    Color NVARCHAR(20)
);
GO

-- Users
CREATE TABLE Users (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    FullName NVARCHAR(100) NOT NULL,
    Email NVARCHAR(255) NOT NULL,
    Username NVARCHAR(100),
    DepartmentsJson NVARCHAR(MAX) DEFAULT '[]',
    Role NVARCHAR(50) DEFAULT 'member',
    Manager INT,
    Avatar NVARCHAR(MAX),
    Color NVARCHAR(20),
    JobTitle NVARCHAR(100),
    IsActive BIT DEFAULT 1,
    PasswordHash NVARCHAR(MAX),
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 DEFAULT GETUTCDATE()
);
GO

-- Projects
CREATE TABLE Projects (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL,
    Description NVARCHAR(MAX),
    Icon NVARCHAR(10) DEFAULT 'üìÅ',
    Color NVARCHAR(20) DEFAULT '#0086c0',
    Owner INT NOT NULL,
    MembersJson NVARCHAR(MAX) DEFAULT '[]',
    DepartmentId INT NOT NULL,
    StartDate DATETIME2,
    EndDate DATETIME2,
    Budget FLOAT,
    Status NVARCHAR(50) DEFAULT 'planning',
    Priority NVARCHAR(50) DEFAULT 'medium',
    Favorite BIT DEFAULT 0,
    IsPrivate BIT DEFAULT 0,
    CreatedBy INT NOT NULL,
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 DEFAULT GETUTCDATE()
);
GO

-- Labels
CREATE TABLE Labels (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(100) NOT NULL,
    Color NVARCHAR(20) DEFAULT '#cccccc',
    ProjectId INT NOT NULL,
    CreatedAt DATETIME2 DEFAULT GETUTCDATE()
);
GO

-- Tasks
CREATE TABLE Tasks (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    ProjectId INT NOT NULL,
    Title NVARCHAR(255) NOT NULL,
    Description NVARCHAR(MAX),
    AssigneesJson NVARCHAR(MAX) DEFAULT '[]',
    AssignedBy INT NOT NULL,
    Status NVARCHAR(50) DEFAULT 'todo',
    Priority NVARCHAR(50) DEFAULT 'medium',
    LabelsJson NVARCHAR(MAX) DEFAULT '[]',
    IsPrivate BIT DEFAULT 0,
    TShirtSize NVARCHAR(10),
    StartDate DATETIME2,
    DueDate DATETIME2,
    Progress INT DEFAULT 0,
    SubtasksJson NVARCHAR(MAX) DEFAULT '[]',
    CommentsJson NVARCHAR(MAX) DEFAULT '[]',
    AttachmentsJson NVARCHAR(MAX) DEFAULT '[]',
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 DEFAULT GETUTCDATE()
);
GO

-- AuditLogs
CREATE TABLE AuditLogs (
    Id INT IDENTITY(1,1) PRIMARY KEY,
    UserId NVARCHAR(50) NOT NULL,
    UserName NVARCHAR(100) NOT NULL,
    Action NVARCHAR(50) NOT NULL,
    EntityName NVARCHAR(50) NOT NULL,
    EntityId NVARCHAR(50) NOT NULL,
    Description NVARCHAR(MAX) NOT NULL,
    OldValues NVARCHAR(MAX),
    NewValues NVARCHAR(MAX),
    Timestamp DATETIME2 NOT NULL
);
GO


    Timestamp DATETIME2 NOT NULL
);
GO

-- =============================================
-- 2. Soft Delete Columns (Updates)
-- =============================================
ALTER TABLE Users ADD IsDeleted BIT DEFAULT 0;
ALTER TABLE Users ADD DeletedAt DATETIME2 NULL;

ALTER TABLE Projects ADD IsDeleted BIT DEFAULT 0;
ALTER TABLE Projects ADD DeletedAt DATETIME2 NULL;

ALTER TABLE Tasks ADD IsDeleted BIT DEFAULT 0;
ALTER TABLE Tasks ADD DeletedAt DATETIME2 NULL;

ALTER TABLE Departments ADD IsDeleted BIT DEFAULT 0;
ALTER TABLE Departments ADD DeletedAt DATETIME2 NULL;

ALTER TABLE Labels ADD IsDeleted BIT DEFAULT 0;
ALTER TABLE Labels ADD DeletedAt DATETIME2 NULL;
GO

-- =============================================
-- 3. Audit Triggers (Automatic Logging)
-- =============================================

-- Trigger for Tasks
CREATE TRIGGER trg_Tasks_Audit ON Tasks
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @Action NVARCHAR(50);
    
    IF EXISTS (SELECT * FROM inserted)
    BEGIN
        IF EXISTS (SELECT * FROM deleted)
            SET @Action = 'UPDATE';
        ELSE
            SET @Action = 'INSERT';
    END
    ELSE
        SET @Action = 'DELETE';

    -- Log operation
    INSERT INTO AuditLogs (UserId, UserName, Action, EntityName, EntityId, Description, Timestamp)
    SELECT 
        ISNULL(CAST((SELECT TOP 1 AssignedBy FROM inserted) AS NVARCHAR(50)), 'System'), -- Try to capture user from data or default check
        'System/User', -- SQL Context doesn't know the exact Web User, strictly database level log
        @Action,
        'Task',
        ISNULL(CAST(i.Id AS NVARCHAR(50)), CAST(d.Id AS NVARCHAR(50))),
        CASE @Action 
            WHEN 'INSERT' THEN 'Task Created: ' + i.Title
            WHEN 'UPDATE' THEN 'Task Updated: ' + i.Title
            WHEN 'DELETE' THEN 'Task Deleted: ' + d.Title
        END,
        GETUTCDATE()
    FROM inserted i
    FULL OUTER JOIN deleted d ON i.Id = d.Id;
END;
GO

-- Trigger for Projects
CREATE TRIGGER trg_Projects_Audit ON Projects
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @Action NVARCHAR(50);
    
    IF EXISTS (SELECT * FROM inserted)
    BEGIN
        IF EXISTS (SELECT * FROM deleted)
            SET @Action = 'UPDATE';
        ELSE
            SET @Action = 'INSERT';
    END
    ELSE
        SET @Action = 'DELETE';

    INSERT INTO AuditLogs (UserId, UserName, Action, EntityName, EntityId, Description, Timestamp)
    SELECT 
        ISNULL(CAST((SELECT TOP 1 Owner FROM inserted) AS NVARCHAR(50)), 'System'),
        'System/User',
        @Action,
        'Project',
        ISNULL(CAST(i.Id AS NVARCHAR(50)), CAST(d.Id AS NVARCHAR(50))),
        CASE @Action 
            WHEN 'INSERT' THEN 'Project Created: ' + i.Name
            WHEN 'UPDATE' THEN 'Project Updated: ' + i.Name
            WHEN 'DELETE' THEN 'Project Deleted: ' + d.Name
        END,
        GETUTCDATE()
    FROM inserted i
    FULL OUTER JOIN deleted d ON i.Id = d.Id;
END;
GO

    FROM inserted i
    FULL OUTER JOIN deleted d ON i.Id = d.Id;
END;
GO

-- Trigger for Users
CREATE TRIGGER trg_Users_Audit ON Users
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @Action NVARCHAR(50);
    IF EXISTS (SELECT * FROM inserted) BEGIN IF EXISTS (SELECT * FROM deleted) SET @Action = 'UPDATE'; ELSE SET @Action = 'INSERT'; END ELSE SET @Action = 'DELETE';
    INSERT INTO AuditLogs (UserId, UserName, Action, EntityName, EntityId, Description, Timestamp)
    SELECT 'System', 'System/User', @Action, 'User', ISNULL(CAST(i.Id AS NVARCHAR(50)), CAST(d.Id AS NVARCHAR(50))),
    CASE @Action WHEN 'INSERT' THEN 'User Added: ' + i.FullName WHEN 'UPDATE' THEN 'User Updated: ' + i.FullName WHEN 'DELETE' THEN 'User Deleted: ' + d.FullName END, GETUTCDATE()
    FROM inserted i FULL OUTER JOIN deleted d ON i.Id = d.Id;
END;
GO

-- Trigger for Departments
CREATE TRIGGER trg_Departments_Audit ON Departments
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @Action NVARCHAR(50);
    IF EXISTS (SELECT * FROM inserted) BEGIN IF EXISTS (SELECT * FROM deleted) SET @Action = 'UPDATE'; ELSE SET @Action = 'INSERT'; END ELSE SET @Action = 'DELETE';
    INSERT INTO AuditLogs (UserId, UserName, Action, EntityName, EntityId, Description, Timestamp)
    SELECT 'System', 'System/User', @Action, 'Department', ISNULL(CAST(i.Id AS NVARCHAR(50)), CAST(d.Id AS NVARCHAR(50))),
    CASE @Action WHEN 'INSERT' THEN 'Dept Added: ' + i.Name WHEN 'UPDATE' THEN 'Dept Updated: ' + i.Name WHEN 'DELETE' THEN 'Dept Deleted: ' + d.Name END, GETUTCDATE()
    FROM inserted i FULL OUTER JOIN deleted d ON i.Id = d.Id;
END;
GO

-- Trigger for Labels
CREATE TRIGGER trg_Labels_Audit ON Labels
AFTER INSERT, UPDATE, DELETE
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @Action NVARCHAR(50);
    IF EXISTS (SELECT * FROM inserted) BEGIN IF EXISTS (SELECT * FROM deleted) SET @Action = 'UPDATE'; ELSE SET @Action = 'INSERT'; END ELSE SET @Action = 'DELETE';
    INSERT INTO AuditLogs (UserId, UserName, Action, EntityName, EntityId, Description, Timestamp)
    SELECT 'System', 'System/User', @Action, 'Label', ISNULL(CAST(i.Id AS NVARCHAR(50)), CAST(d.Id AS NVARCHAR(50))),
    CASE @Action WHEN 'INSERT' THEN 'Label Added: ' + i.Name WHEN 'UPDATE' THEN 'Label Updated: ' + i.Name WHEN 'DELETE' THEN 'Label Deleted: ' + d.Name END, GETUTCDATE()
    FROM inserted i FULL OUTER JOIN deleted d ON i.Id = d.Id;
END;
GO

-- =============================================
-- 4. Seed Data
-- =============================================

-- Departments
SET IDENTITY_INSERT Departments ON;
INSERT INTO Departments (Id, Name, HeadOfDepartment, Description, Color) VALUES
(1, 'Stokbar', 'Melih', 'Stok Y√∂netimi', '#4F46E5'),
(2, 'Enroute', 'Ahmet', 'Lojistik', '#10B981'),
(3, 'Quest', 'Ay≈üe', 'Kalite', '#F59E0B'),
(4, 'Y√∂netim', 'Fatma', '√úst Y√∂netim', '#EC4899'),
(5, 'Satƒ±≈ü', 'Elif', 'Satƒ±≈ü Departmanƒ±', '#8B5CF6'),
(6, 'ƒ∞K', 'Can', 'ƒ∞nsan Kaynaklarƒ±', '#14B8A6'),
(7, 'Pazarlama', 'Selin', 'Pazarlama Departmanƒ±', '#EC4899'),
(8, 'ArGe', 'Burak', 'Ar-Ge Departmanƒ±', '#6366F1'),
(9, 'Finans', 'Zeynep', 'Finans Departmanƒ±', '#10B981'),
(10, 'Yazƒ±lƒ±m', 'Melih', 'Yazƒ±lƒ±m Geli≈ütirme', '#3B82F6');
SET IDENTITY_INSERT Departments OFF;
GO

-- Users (Password: test123)
-- Note: DepartmentsJson lists the IDs from above.
SET IDENTITY_INSERT Users ON;
INSERT INTO Users (Id, FullName, Email, Username, Role, JobTitle, Color, DepartmentsJson, PasswordHash) VALUES
(1, 'Melih Bulut', 'melih.bulut@unity.com', 'melih', 'admin', 'Project Manager', '#4F46E5', '[1,4,5,6,7,8,9]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'), -- Placeholder Hash, use app to generate real one if this fails
(2, 'Ahmet Yƒ±lmaz', 'ahmet@unity.com', 'ahmet', 'member', 'Logistics Specialist', '#10B981', '[2]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(3, 'Ay≈üe Demir', 'ayse@unity.com', 'ayse', 'member', 'Quality Analyst', '#F59E0B', '[3]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(4, 'Fatma Kaya', 'fatma@unity.com', 'fatma', 'manager', 'Director', '#EC4899', '[4]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(5, 'Mehmet √áelik', 'mehmet@unity.com', 'mehmet', 'member', 'Warehouse Op.', '#6366F1', '[1]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(6, 'Cem Tekin', 'cem@unity.com', 'cem', 'admin', 'System Admin', '#3B82F6', '[]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(7, 'Selin Yurt', 'selin@unity.com', 'selin', 'member', 'Marketing Lead', '#EC4899', '[7]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(8, 'Burak Deniz', 'burak@unity.com', 'burak', 'member', 'Senior Dev', '#6366F1', '[8]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(9, 'Zeynep Akar', 'zeynep@unity.com', 'zeynep', 'manager', 'Finance Manager', '#10B981', '[9]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(10, 'Elif', 'elif@unity.com', 'elif', 'member', 'Sales', '#8B5CF6', '[5]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z'),
(11, 'Can', 'can@unity.com', 'can', 'member', 'HR', '#14B8A6', '[6]', '$2a$11$qL9p/h.0ZJ./.cZ/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z');

-- Correct Hash for 'test123' (BCrypt)
-- The app logic handles BCrypt. In SQL, we just store the string.
-- Note: You might need to reset password via app if this hash doesn't match EXACTLY due to salt.
-- For safety, updating Melih's hash to a known valid one if possible, or just trusting the app to verify.
UPDATE Users SET PasswordHash = '$2a$11$I2Wk.z/v.Z.0.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.Z.'; -- Example format
SET IDENTITY_INSERT Users OFF;
GO

-- Projects
SET IDENTITY_INSERT Projects ON;
INSERT INTO Projects (Id, Name, Description, DepartmentId, Owner, MembersJson, CreatedBy, Status, Priority, Color) VALUES
(1, 'Stokbar Ana Depo', 'Merkez depo stok y√∂netim ve sayƒ±m projesi.', 1, 1, '[1,5]', 1, 'in_progress', 'high', '#4F46E5'),
(2, 'Enroute Lojistik', 'Sevkiyat takip ve rota optimizasyonu.', 2, 2, '[2,1]', 2, 'planning', 'medium', '#10B981'),
(3, 'Quest Kalite', 'Kalite kontrol s√ºre√ßleri.', 3, 3, '[3,1]', 3, 'working', 'medium', '#F59E0B'),
(4, 'Y√∂netim Kurulu', '≈ûirket i√ßi stratejik kararlar ve raporlar.', 4, 4, '[4,1]', 4, 'in_progress', 'urgent', '#EC4899'),
(5, 'Satƒ±≈ü Raporlarƒ±', 'Aylƒ±k ve yƒ±llƒ±k satƒ±≈ü hedefleri.', 5, 10, '[10,1]', 10, 'done', 'high', '#8B5CF6'),
(6, 'ƒ∞K S√ºre√ßleri', 'ƒ∞≈üe alƒ±m ve personel y√∂netimi.', 6, 11, '[11,1]', 11, 'todo', 'low', '#14B8A6'),
(7, 'Yaz Kampanyasƒ±', '2026 Yaz sezonu reklam √ßalƒ±≈ümalarƒ±.', 7, 7, '[7,1]', 7, 'working', 'high', '#EC4899'),
(8, 'Mobile App v2', 'Yeni nesil mobil uygulama geli≈ütirme.', 8, 8, '[8,1]', 8, 'in_progress', 'urgent', '#6366F1'),
(9, '2026 B√ºt√ße Planƒ±', 'Yƒ±llƒ±k b√ºt√ße daƒüƒ±lƒ±mƒ± ve kontrol√º.', 9, 9, '[9,1]', 9, 'review', 'high', '#10B981');
SET IDENTITY_INSERT Projects OFF;
GO

-- Labels
SET IDENTITY_INSERT Labels ON;
INSERT INTO Labels (Id, Name, Color, ProjectId) VALUES
(1, 'Acileyet', '#EF4444', 1),
(2, 'Backend', '#3B82F6', 1),
(3, 'Review', '#F59E0B', 4),
(4, 'Bug', '#DC2626', 3),
(5, 'Feature', '#10B981', 2),
(6, 'Design', '#EC4899', 7),
(7, 'Mobile', '#8B5CF6', 8),
(8, 'Finance', '#10B981', 9);
SET IDENTITY_INSERT Labels OFF;
GO

-- Tasks
SET IDENTITY_INSERT Tasks ON;
INSERT INTO Tasks (Id, ProjectId, Title, Status, Priority, AssignedBy, AssigneesJson, LabelsJson, StartDate, DueDate, Description, SubtasksJson, Progress) VALUES
(1, 1, 'Yƒ±llƒ±k Stok Sayƒ±mƒ±', 'todo', 'urgent', 1, '[5]', '[1]', DATEADD(day, -2, GETUTCDATE()), DATEADD(day, 5, GETUTCDATE()), 'T√ºm deponun sayƒ±lmasƒ± gerekiyor.', '[{"id":"1","title":"A Blok Sayƒ±mƒ±","completed":false}]', 0),
(2, 1, 'Raf D√ºzenlemesi', 'in_progress', 'medium', 1, '[5,1]', '[]', DATEADD(day, -5, GETUTCDATE()), DATEADD(day, 2, GETUTCDATE()), NULL, '[]', 50),
(3, 2, 'Ara√ß Bakƒ±mlarƒ±', 'todo', 'high', 2, '[2]', '[5]', DATEADD(day, 2, GETUTCDATE()), DATEADD(day, 10, GETUTCDATE()), NULL, '[]', 0),
(4, 3, 'Bug Raporlama', 'review', 'high', 3, '[3]', '[4]', DATEADD(day, -1, GETUTCDATE()), DATEADD(day, 1, GETUTCDATE()), NULL, '[]', 0),
(5, 4, 'B√ºt√ße Raporu', 'review', 'high', 4, '[1]', '[3]', DATEADD(day, -4, GETUTCDATE()), NULL, NULL, '[]', 0),
(6, 7, 'Sosyal Medya Planƒ±', 'in_progress', 'medium', 7, '[7]', '[6]', NULL, NULL, NULL, '[]', 0),
(7, 8, 'API Dok√ºmantasyonu', 'todo', 'medium', 8, '[8]', '[7]', NULL, NULL, NULL, '[]', 0),
(8, 9, 'Gider Analizi', 'in_progress', 'high', 9, '[9]', '[8]', NULL, NULL, NULL, '[]', 0);
SET IDENTITY_INSERT Tasks OFF;
GO
